<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATEM ATTACK!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --program-color: #e6482e; /* SNES Red */
            --preview-color: #3fdb67; /* SNES Green */
            --key-color: #4d90f1;     /* SNES Blue */
            --active-light: #ffffff; 
            --base-gray-light: #c6c6c6; /* Light UI Gray */
            --base-gray-dark: #7b7b7b;  /* Dark UI Gray */
            --panel-color: #9d9d9d;    /* Main panel gray */
            --dark-border: #1c1c1c;    /* Black border */
            --light-border: #efefef;   /* White highlight */
            --bg-dark: #2d2b47;        /* Dark purple bg */
            --bg-light: #3c3c54;       /* Lighter purple bg */
        }

        body {
            background-color: var(--bg-dark);
            background-image: url('https://photos.smugmug.com/Randoimages/i-LtrCcHL/0/546f0431/5K/Rando-5K.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: var(--active-light);
            font-family: 'Press Start 2P', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        
        .shake-body {
            animation: body-shake 0.3s ease-in-out;
        }
        @keyframes body-shake {
            25% { transform: translateX(5px); }
            50% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        /* --- NEW BANNER STYLES --- */
        .arcade-banner {
            width: 82%;
            background-color: #000;
            border: 4px solid var(--dark-border);
            border-bottom: none;
            padding: 10px;
            text-align: center;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            border-image: linear-gradient(45deg, var(--key-color), var(--program-color), var(--preview-color)) 1;
            border-image-slice: 1;
            border-width: 8px;
        }

        .banner-title {
            font-size: 2em;
            color: var(--active-light);
            text-shadow: 4px 4px 0 var(--program-color), 
                         -4px -4px 0 var(--key-color);
            animation: flicker 1.5s infinite alternate;
        }
        
        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% {
                text-shadow:
                4px 4px 0 var(--program-color),
                -4px -4px 0 var(--key-color),
                0 0 10px #fff,
                0 0 20px #fff,
                0 0 30px var(--preview-color),
                0 0 40px var(--preview-color);
            }
            20%, 24%, 55% {        
                text-shadow: none;
            }
        }

        /* --- UI STYLES --- */
        .game-ui {
            width: 80%;
            background-color: var(--panel-color);
            border: 4px solid var(--dark-border);
            border-top-color: var(--light-border);
            border-left-color: var(--light-border);
            padding: 10px 20px;
            margin-bottom: 15px;
            position: relative;
        }
        .game-info {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
        }
        .game-info h2 {
            margin: 0;
            font-size: 1em; 
            color: var(--dark-border);
        }
        .prompt-box {
            background-color: #000;
            width: 100%;
            padding: 12px;
            min-height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 2px solid var(--dark-border);
        }
        #prompt-text {
            margin: 0;
            font-size: 0.8em;
            font-style: normal;
            color: var(--preview-color);
            transition: all 0.2s ease;
            letter-spacing: 1px;
            line-height: 1.5;
        }
       
        #score-display.flash {
            animation: score-flash 0.5s ease;
        }
        @keyframes score-flash {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); color: var(--preview-color); }
            100% { transform: scale(1); }
        }
        
        #confetti-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; overflow: hidden; z-index: 9999;
        }

        .confetti {
            position: absolute; width: 6px; height: 6px;
            background-color: #f00; opacity: 1;
        }

        #feedback-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: var(--preview-color);
            opacity: 0;
            margin: 0;
            pointer-events: none;
            z-index: 100;
            text-shadow: 3px 3px var(--dark-border);
            white-space: nowrap;
        }
        #feedback-text.show {
            animation: feedback-anim 1.2s ease-out forwards;
        }
        @keyframes feedback-anim {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            20%, 60% { transform: translate(-50%, -50%) scale(1.1); }
            40%, 80% { transform: translate(-50%, -50%) scale(1); }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        
        .monitor-flash {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: white;
            opacity: 0;
            pointer-events: none;
        }
        .monitor-flash.flash {
            animation: flash-anim 0.4s ease-out;
        }
        @keyframes flash-anim {
            0% { opacity: 0.7; }
            100% { opacity: 0; }
        }

        .progress-container {
            width: 100%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            font-size: 0.6em;
            color: var(--dark-border);
        }
        .progress-label {
            padding: 0 10px;
            white-space: nowrap;
        }
        .progress-bar-outline {
            flex-grow: 1;
            height: 20px;
            border: 2px solid var(--dark-border);
            border-top-color: var(--base-gray-dark);
            border-left-color: var(--base-gray-dark);
            background-color: #000;
            padding: 2px;
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background-color: var(--preview-color);
            transition: width 0.5s ease-out;
        }

        .monitors {
            display: flex;
            justify-content: center;
            width: 80%;
            margin-bottom: 10px;
        }

        .monitor {
            background-color: #000;
            border: 4px solid var(--dark-border);
            border-top-color: var(--light-border);
            border-left-color: var(--light-border);
            width: 45%;
            height: 25vh;
            margin: 0 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .monitor-label {
            background-color: var(--dark-gray);
            color: var(--light-border);
            text-align: center;
            padding: 5px;
            font-size: 0.8em;
            flex-shrink: 0;
        }

        .monitor-content {
            width: 100%; height: 100%; display: flex; align-items: center;
            justify-content: center; position: relative;
        }
        
        .monitor-content > div, 
        .monitor-content img, 
        .monitor-content svg { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
        }

        .monitor-content svg {
            shape-rendering: crispEdges;
        }
        
        .key-overlay {
            position: absolute; width: 100%; height: 100%;
            top: 0; left: 0; opacity: 0;
            transition: opacity 0.2s step-end; pointer-events: none;
        }
        .key-overlay.visible { opacity: 1; }
        
        #preview-label { color: var(--preview-color); }
        #program-label { color: var(--program-color); }

        .atem-switcher {
            background-color: var(--panel-color);
            padding: 15px;
            display: grid;
            grid-template-columns: 3fr 1fr;
            grid-gap: 20px;
            width: 80%;
            border: 4px solid var(--dark-border);
            border-top-color: var(--light-border);
            border-left-color: var(--light-border);
        }

        .bus-row { margin-bottom: 15px; }
        .bus-label { margin-bottom: 8px; font-size: 0.8em; color: var(--dark-border); }
        .buttons { display: flex; justify-content: space-between; }

        .btn {
            background-color: var(--base-gray-light);
            border-style: solid;
            border-width: 2px;
            border-color: var(--light-border) var(--dark-border) var(--dark-border) var(--light-border);
            color: var(--dark-border);
            padding: 10px 5px; font-size: 9px;
            font-family: 'Press Start 2P', monospace; cursor: pointer;
            flex-grow: 1; margin: 0 2px; text-align: center;
            -webkit-user-select: none; user-select: none;
            line-height: 1.2;
        }

        .btn:active, .btn.pushed {
            border-color: var(--dark-border) var(--light-border) var(--light-border) var(--dark-border);
        }
        
        .key-bus .btn.active, .dsk-btn:not(.active) { background-color: var(--key-color); color: var(--active-light); text-shadow: 1px 1px var(--dark-border); }
        .program-bus .btn.active, .on-btn.active, .dsk-btn.active { background-color: var(--program-color); color: var(--active-light); text-shadow: 1px 1px var(--dark-border);}
        .preview-bus .btn.active, .keyer-btn.active { background-color: var(--preview-color); color: var(--dark-border); }
        .background-btn.active { background-color: var(--program-color); color: var(--active-light); text-shadow: 1px 1px var(--dark-border); }

        .side-controls { display: flex; flex-direction: column; }
        .key-buttons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 10px; }
        .side-controls .btn.active { background-color: var(--light-border); color: var(--dark-border); }
        
        .transition-controls { display: flex; justify-content: space-around; margin-top: auto; }
        .momentary-btn { padding: 15px 10px; font-size: 14px; }
        .cut-btn { background-color: var(--program-color); }
        .auto-btn { background-color: var(--preview-color); }

        .dsk-controls {
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
        .dsk-btn {
            width: 100%; padding: 10px; font-size: 1em;
        }
        
        #goal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 10000;
            flex-direction: column;
            cursor: pointer;
            overflow: hidden;
        }
        #goal-overlay.show {
            display: flex;
        }
        #goal-text {
            font-size: 1.5em;
            line-height: 2;
            color: var(--active-light);
            text-shadow: 2px 2px var(--dark-border);
            padding: 20px;
            z-index: 10002;
        }

        #success-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: auto;
            border: 4px solid var(--dark-border);
            opacity: 0;
            transform: scale(0.5) rotate(-15deg);
            transition: all 0.3s ease-in-out;
            pointer-events: none;
            z-index: 10001;
        }
        #success-popup.show {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }
        
        #dsk2-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10; 
        }
        #dsk2-overlay.show {
            display: flex;
        }
        #dsk2-overlay img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #bouncing-logo {
            position: absolute;
            width: 150px;
            height: auto;
            z-index: 10001;
            animation: bounce 10s linear infinite;
        }

        @keyframes bounce {
            0% { top: 0; left: 0; }
            25% { top: 0; left: calc(100% - 150px); }
            50% { top: calc(100% - 150px); left: calc(100% - 150px); }
            75% { top: calc(100% - 150px); left: 0; }
            100% { top: 0; left: 0; }
        }

    </style>
</head>
<body>

    <!-- Generated SVG Images -->
    <div id="image-sources" style="display: none;">
        <!-- Video Sources -->
        <img id="img-cam-1" src="https://photos.smugmug.com/Randoimages/i-QJ8cF7b/0/3e7d5663/4K/Image-4K.jpg">
        <img id="img-cam-2" src="https://photos.smugmug.com/Randoimages/i-4HkqZ6m/0/955403e0/4K/Image-4K.jpg">
        <img id="img-cam-3" src="https://photos.smugmug.com/Randoimages/i-CzSc9SN/0/f65c5c04/4K/Image-4K.jpg">
        <img id="img-class-pc" src="https://photos.smugmug.com/Randoimages/i-zGFBsRP/0/566219b2/4K/Image-4K.jpg">
        <img id="img-control-pc" src="https://photos.smugmug.com/Randoimages/i-4LcVvH5/0/5d1f5e8f/4K/Image-4K.jpg">
        <img id="img-mp-1" src="https://photos.smugmug.com/Maine/i-3cSdpPf/0/a9b8823b/5K/September-Morning--5K.jpg">
        <img id="img-mp-2" src="https://photos.smugmug.com/Randoimages/i-vxVcVtx/0/1881b244/4K/Image-4K.jpg">
        <div id="img-color" style="width: 100%; height: 100%; background-color: #2980b9;"></div>
        <svg id="img-bars" viewBox="0 0 7 6"><rect fill="#C0C0C0" width="1" height="4"/><rect fill="#C0C000" x="1" width="1" height="4"/><rect fill="#00C0C0" x="2" width="1" height="4"/><rect fill="#00C000" x="3" width="1" height="4"/><rect fill="#C000C0" x="4" width="1" height="4"/><rect fill="#C00000" x="5" width="1" height="4"/><rect fill="#0000C0" x="6" width="1" height="4"/><rect fill="#0000C0" y="4" width="1" height="2"/><rect fill="#000000" x="1" y="4" width="1" height="2"/><rect fill="#C000C0" x="2" y="4" width="1" height="2"/><rect fill="#000000" x="3" y="4" width="1" height="2"/><rect fill="#00C0C0" x="4" y="4" width="1" height="2"/><rect fill="#000000" x="5" y="4" width="1" height="2"/><rect fill="#C0C0C0" x="6" y="4" width="1" height="2"/></svg>
        <div id="img-black" style="width: 100%; height: 100%; background-color: #000;"></div>

        <!-- Key Graphics -->
        <svg id="key-graphic-1" viewBox="0 0 200 40"><rect x="0" y="10" width="200" height="20" fill="rgba(0,50,150,0.8)" /><text x="100" y="26" font-size="12" fill="#fff" text-anchor="middle" font-family="sans-serif">JANE DOE - HOST</text></svg>
        <svg id="key-graphic-2" viewBox="0 0 100 100"><circle cx="80" cy="20" r="15" fill="rgba(200,0,0,0.9)" /><text x="80" y="25" font-size="14" fill="#fff" text-anchor="middle" font-family="sans-serif" font-weight="bold">LIVE</text></svg>
        <svg id="key-graphic-3" viewBox="0 0 100 40"><rect x="10" y="10" width="80" height="20" fill="rgba(200,100,0,0.9)" /><text x="50" y="25" font-size="14" fill="#fff" text-anchor="middle" font-family="sans-serif">REPLAY</text></svg>
        <svg id="key-graphic-4" viewBox="0 0 100 100"><rect x="10" y="60" width="80" height="20" fill="rgba(0,100,50,0.9)" /><text x="50" y="75" font-size="10" fill="#fff" text-anchor="middle" font-family="sans-serif">MEGA CORP</text></svg>
    </div>

    <div id="confetti-container"></div>
    
    <div id="goal-overlay">
        <img id="bouncing-logo" src="https://photos.smugmug.com/Randoimages/i-dfP4k8w/0/a6a66160/4K/Rando-4K.jpg">
        <div id="goal-text"></div>
    </div>
    
    <img id="success-popup" src="">

    <!-- NEW Banner -->
    <div class="arcade-banner">
        <h1 class="banner-title">ATEM ATTACK!</h1>
    </div>

    <!-- Game UI -->
    <div class="game-ui">
        <h2 id="feedback-text"></h2>
        <div class="game-info">
             <h2>SCORE: <span id="score-display">0</span></h2>
        </div>
        <div class="prompt-box" id="prompt-box">
            <p id="prompt-text">Press DSK2 to begin!</p>
        </div>
        <div class="progress-container">
            <div class="progress-label">Live in 3,2,1...</div>
            <div class="progress-bar-outline">
                <div class="progress-bar-fill" id="progress-bar"></div>
            </div>
            <div class="progress-label">Roll Credits!</div>
        </div>
    </div>

    <div class="monitors">
        <div class="monitor">
            <div class="monitor-label" id="preview-label">Preview</div>
            <div class="monitor-content" id="preview-screen">
                <div id="preview-source-container"></div>
                <div class="monitor-flash"></div>
            </div>
        </div>
        <div class="monitor">
            <div class="monitor-label" id="program-label">Program</div>
            <div class="monitor-content" id="program-screen">
                <div id="program-source-container"></div>
                <div id="key-1-container" class="key-overlay"></div>
                <div id="key-2-container" class="key-overlay"></div>
                <div id="key-3-container" class="key-overlay"></div>
                <div id="key-4-container" class="key-overlay"></div>
                <div class="monitor-flash"></div>
                <div id="dsk2-overlay"><img src="https://photos.smugmug.com/Randoimages/i-vxVcVtx/0/1881b244/4K/Image-4K.jpg"></div>
            </div>
        </div>
    </div>

    <div class="atem-switcher">
        <div class="bus-section">
            <div class="bus-row key-bus">
                <div class="bus-label">Key Bus</div>
                <div class="buttons">
                    <button class="btn">CAM 1</button><button class="btn">CAM 2</button><button class="btn">DOCUMENT CAM</button><button class="btn">CLASS PC</button><button class="btn">CONTROL PC</button><button class="btn">MEDIA PLAYER 1</button><button class="btn">MEDIA PLAYER 2</button><button class="btn">COLOR</button><button class="btn">BARS</button><button class="btn">BLACK</button>
                </div>
            </div>
            <div class="bus-row program-bus">
                <div class="bus-label">Program Bus</div>
                <div class="buttons">
                    <button class="btn" data-source-id="img-cam-1">CAM 1</button><button class="btn" data-source-id="img-cam-2">CAM 2</button><button class="btn" data-source-id="img-cam-3">DOCUMENT CAM</button><button class="btn" data-source-id="img-class-pc">CLASS PC</button><button class="btn" data-source-id="img-control-pc">CONTROL PC</button><button class="btn" data-source-id="img-mp-1">MEDIA PLAYER 1</button><button class="btn" data-source-id="img-mp-2">MEDIA PLAYER 2</button><button class="btn" data-source-id="img-color">COLOR</button><button class="btn" data-source-id="img-bars">BARS</button><button class="btn" data-source-id="img-black">BLACK</button>
                </div>
            </div>
             <div class="bus-row preview-bus">
                <div class="bus-label">Preview Bus</div>
                <div class="buttons">
                    <button class="btn" data-source-id="img-cam-1">CAM 1</button><button class="btn" data-source-id="img-cam-2">CAM 2</button><button class="btn" data-source-id="img-cam-3">DOCUMENT CAM</button><button class="btn" data-source-id="img-class-pc">CLASS PC</button><button class="btn" data-source-id="img-control-pc">CONTROL PC</button><button class="btn" data-source-id="img-mp-1">MEDIA PLAYER 1</button><button class="btn" data-source-id="img-mp-2">MEDIA PLAYER 2</button><button class="btn" data-source-id="img-color">COLOR</button><button class="btn" data-source-id="img-bars">BARS</button><button class="btn" data-source-id="img-black">BLACK</button>
                </div>
            </div>
        </div>
        <div class="side-controls">
            <div class="key-buttons">
                <button class="btn">MACRO</button><button class="btn on-btn" data-key-id="1">ON</button><button class="btn on-btn" data-key-id="2">ON</button><button class="btn on-btn" data-key-id="3">ON</button><button class="btn on-btn" data-key-id="4">ON</button>
                <button class="btn background-btn">BACKGROUND</button><button class="btn keyer-btn" data-key-id="1">KEY 1</button><button class="btn keyer-btn" data-key-id="2">KEY 2</button><button class="btn keyer-btn" data-key-id="3">KEY 3</button><button class="btn keyer-btn" data-key-id="4">KEY 4</button>
            </div>
            <div class="transition-controls">
                <button class="btn momentary-btn cut-btn">CUT</button>
                <button class="btn momentary-btn auto-btn">AUTO</button>
            </div>
            <div class="dsk-controls">
                <button class="btn dsk-btn" id="dsk1-btn">DSK1</button>
                <button class="btn dsk-btn" id="dsk2-btn">DSK2</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const programScreen = document.getElementById('program-screen');
        const previewScreen = document.getElementById('preview-screen');
        const programSourceContainer = document.getElementById('program-source-container');
        const previewSourceContainer = document.getElementById('preview-source-container');
        const imageSources = document.getElementById('image-sources');
        const scoreDisplay = document.getElementById('score-display');
        const promptText = document.getElementById('prompt-text');
        const promptBox = document.getElementById('prompt-box');
        const dsk2Button = document.getElementById('dsk2-btn');
        const confettiContainer = document.getElementById('confetti-container');
        const feedbackText = document.getElementById('feedback-text');
        const progressBar = document.getElementById('progress-bar');
        const goalOverlay = document.getElementById('goal-overlay');
        const goalText = document.getElementById('goal-text');
        const successPopup = document.getElementById('success-popup');
        const dsk2Overlay = document.getElementById('dsk2-overlay');

        // --- GAME STATE ---
        let score = 0;
        const GOAL_SCORE = 1500;
        let currentPrompt = null;
        let gameStarted = false;
        let goalReached = false;
        let availablePrompts = [];
        const keyerGraphics = {
            1: 'key-graphic-1', 2: 'key-graphic-2',
            3: 'key-graphic-3', 4: 'key-graphic-4'
        };
        const activeKeys = new Set();
        const armedKeys = new Set();
        let goalConfettiInterval = null;
        let lastCorrectTimestamp = null;
        const BASE_POINTS_PER_ELEMENT = 100;
        const PENALTY_PER_SECOND = 4;
        
        const customSounds = {
            correct: '',
            click: 'https://www.myinstants.com/media/sounds/mouse-click-sound-effect-hd.mp3', 
        };
        
        const successImageUrl = 'https://photos.smugmug.com/Randoimages/i-dfP4k8w/0/a6a66160/4K/Rando-4K.jpg';
        const ouchImageUrl = 'https://photos.smugmug.com/Randoimages/i-fFwCn2T/0/7d4e414c/4K/Rando-4K.jpg';

        // --- COMBINED PROMPT DEFINITIONS ---
        const gamePrompts = [
            { text: "Show me Camera 1, clean.", targetSource: "img-cam-1", targetKeys: {} },
            { text: "I need the Class PC on Program.", targetSource: "img-class-pc", targetKeys: {} },
            { text: "Put Media Player 1 on the air.", targetSource: "img-mp-1", targetKeys: {} },
            { text: "Give me the wide shot on Cam 2.", targetSource: "img-cam-2", targetKeys: {} },
            { text: "Let's see the Control PC feed.", targetSource: "img-control-pc", targetKeys: {} },
            { text: "Take it to black.", targetSource: "img-black", targetKeys: {} },
            { text: "I want Camera 1 with the host's lower third (Key 1).", targetSource: "img-cam-1", targetKeys: { 1: 'on' } },
            { text: "Show me Camera 2 with the LIVE bug (Key 2).", targetSource: "img-cam-2", targetKeys: { 2: 'on' } },
            { text: "Put the Class PC up, and add the Sponsor logo (Key 4).", targetSource: "img-class-pc", targetKeys: { 4: 'on' } },
            { text: "I need Camera 1 with the Replay graphic (Key 3) and the Sponsor logo (Key 4).", targetSource: "img-cam-1", targetKeys: { 3: 'on', 4: 'on' } },
            { text: "Let's see Camera 2 with the lower third (Key 1) and the LIVE bug (Key 2).", targetSource: "img-cam-2", targetKeys: { 1: 'on', 2: 'on' } },
            { text: "Show me the Document Cam, clean.", targetSource: "img-cam-3", targetKeys: {} },
            { text: "Put up the color bars.", targetSource: "img-bars", targetKeys: {} },
            { text: "Let's see that solid blue color source.", targetSource: "img-color", targetKeys: {} },
            { text: "Give me the Document Cam with the LIVE bug (Key 2).", targetSource: "img-cam-3", targetKeys: { 2: 'on' } },
            { text: "I need the Control PC with the Sponsor logo (Key 4).", targetSource: "img-control-pc", targetKeys: { 4: 'on' } },
            { text: "Show the Class PC with the Replay graphic (Key 3).", targetSource: "img-class-pc", targetKeys: { 3: 'on' } },
            { text: "I want Camera 2 with just the lower third (Key 1).", targetSource: "img-cam-2", targetKeys: { 1: 'on' } },
            { text: "Give me Media Player 1 with the LIVE bug (Key 2).", targetSource: "img-mp-1", targetKeys: { 2: 'on' } },
            { text: "Show Camera 1, but lose all graphics.", targetSource: "img-cam-1", targetKeys: {} },
            { text: "Let's see the Class PC feed, clean.", targetSource: "img-class-pc", targetKeys: {} },
            { text: "I need the Document Cam with the host's lower third (Key 1).", targetSource: "img-cam-3", targetKeys: { 1: 'on' } },
            { text: "Put up the Control PC with the Replay graphic (Key 3).", targetSource: "img-control-pc", targetKeys: { 3: 'on' } },
            { text: "Show Media Player 2 with the Sponsor logo (Key 4).", targetSource: "img-mp-2", targetKeys: { 4: 'on' } },
            { text: "I want the Document Cam with both the lower third (Key 1) and the LIVE bug (Key 2).", targetSource: "img-cam-3", targetKeys: { 1: 'on', 2: 'on' } },
            { text: "Give me the Control PC feed with the Replay (Key 3) and Sponsor (Key 4) graphics.", targetSource: "img-control-pc", targetKeys: { 3: 'on', 4: 'on' } },
            { text: "Show me Camera 1 with just the LIVE bug (Key 2).", targetSource: "img-cam-1", targetKeys: { 2: 'on' } },
            { text: "I need Camera 2 with the Replay graphic (Key 3).", targetSource: "img-cam-2", targetKeys: { 3: 'on' } },
            { text: "Put up Media Player 2, clean.", targetSource: "img-mp-2", targetKeys: {} },
            { text: "Let's see the Document Cam with the Sponsor logo (Key 4).", targetSource: "img-cam-3", targetKeys: { 4: 'on' } },
            { text: "Show me the Class PC with both the lower third (Key 1) and Sponsor logo (Key 4).", targetSource: "img-class-pc", targetKeys: { 1: 'on', 4: 'on' } }
        ];

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
             const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain(); oscillator.connect(gainNode); gainNode.connect(audioCtx.destination); gainNode.gain.setValueAtTime(0, audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);
             if (type === 'correct') { oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(880.0, audioCtx.currentTime); }
             else if (type === 'click') { oscillator.type = 'square'; oscillator.frequency.setValueAtTime(1200, audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01); }
             else { oscillator.type = 'square'; oscillator.frequency.setValueAtTime(110.0, audioCtx.currentTime); }
             oscillator.start(audioCtx.currentTime);
             const duration = (type === 'click') ? 0.03 : 0.1;
             gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
             oscillator.stop(audioCtx.currentTime + duration);
        }

        function playVoiceFeedback(text) {
            if (customSounds.correct) {
                new Audio(customSounds.correct).play();
                return;
            }
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.pitch = 0.1; 
                utterance.rate = 0.6; 
                utterance.volume = 1;
                window.speechSynthesis.speak(utterance);
            } else {
                playSound('correct'); // Fallback
            }
        }

        // --- PIZZAZ FUNCTIONS ---
        function triggerSuccessAnimation(points, message) {
            playVoiceFeedback(message);
            triggerConfetti();
            document.body.classList.add('shake-body');
            document.querySelector('#program-screen').parentElement.querySelector('.monitor-flash').classList.add('flash');
            
            if (points === 0) {
                successPopup.src = ouchImageUrl;
            } else {
                successPopup.src = successImageUrl;
            }
            successPopup.classList.add('show');

            feedbackText.textContent = `${message} +${points}`;
            feedbackText.classList.add('show');
            
            setTimeout(() => {
                feedbackText.classList.remove('show');
                document.body.classList.remove('shake-body');
                document.querySelector('#program-screen').parentElement.querySelector('.monitor-flash').classList.remove('flash');
            }, 1200);

            setTimeout(() => {
                successPopup.classList.remove('show');
            }, 1500);
        }

        function triggerGoalReachedAnimation() {
            goalText.innerHTML = `Well done! The professor was happy with the production!<br><br>Final Score: ${score}<br><br>Click anywhere to continue.`;
            goalOverlay.classList.add('show');
            goalConfettiInterval = setInterval(triggerConfetti, 500);
        }

        function hideGoalOverlay() {
            goalOverlay.classList.remove('show');
            clearInterval(goalConfettiInterval);
        }

        function triggerConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                const colors = ['#d6495f', '#75c179', '#6ec5d9', '#f2f0f3'];
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                confetti.style.left = `${window.innerWidth / 2}px`;
                confetti.style.top = `${window.innerHeight / 2}px`;

                const animationName = `confetti-fall-${i}`;
                const xEnd = Math.random() * 400 - 200;
                const yEnd = Math.random() * 200 + 100;

                const keyframes = `@keyframes ${animationName} {
                    0% { transform: translate(0, 0) rotateZ(0); opacity: 1; }
                    30% { transform: translate(${xEnd * 0.5}px, -${yEnd}px) rotateZ(180deg); opacity: 1; }
                    100% { transform: translate(${xEnd}px, 100vh) rotateZ(360deg); opacity: 0; }
                }`;
                
                let dynamicStyleSheet = document.getElementById('dynamic-styles');
                if (!dynamicStyleSheet) {
                    dynamicStyleSheet = document.createElement('style');
                    dynamicStyleSheet.id = 'dynamic-styles';
                    document.head.appendChild(dynamicStyleSheet);
                }
                dynamicStyleSheet.sheet.insertRule(keyframes, dynamicStyleSheet.sheet.cssRules.length);
                
                confetti.style.animation = `${animationName} ${1.5 + Math.random()}s ease-out forwards`;
                confettiContainer.appendChild(confetti);

                setTimeout(() => confetti.remove(), 2500);
            }
        }


        // --- GAME LOGIC ---
        function startGame() {
            score = 0;
            updateScoreboard();
            availablePrompts = [...gamePrompts];
            lastCorrectTimestamp = null;
            displayNewPrompt();
            gameStarted = true;
            goalReached = false;
            goalOverlay.classList.remove('show');
            clearInterval(goalConfettiInterval);
            dsk2Overlay.classList.remove('show');
        }

        function endGame() {
            gameStarted = false;
            dsk2Button.classList.add('active');
            dsk2Overlay.classList.add('show');
            currentPrompt = null;
            promptText.textContent = `Round ended. Press DSK2 to start a new class.`;
        }

        function updateScoreboard() { 
            scoreDisplay.textContent = score; 
            scoreDisplay.classList.add('flash');
            setTimeout(() => scoreDisplay.classList.remove('flash'), 500);
            const progress = Math.min((score / GOAL_SCORE) * 100, 100);
            progressBar.style.width = `${progress}%`;
        }

        function isPromptValid(p) {
            const currentProgramSource = document.querySelector('.program-bus .btn.active')?.dataset.sourceId;
            const targetOnKeys = new Set();
            for (const keyIdStr in p.targetKeys) {
                if (p.targetKeys[keyIdStr] === 'on') {
                    targetOnKeys.add(parseInt(keyIdStr));
                }
            }
            const programSourceMatches = p.targetSource === currentProgramSource;
            const keysMatch = activeKeys.size === targetOnKeys.size && [...activeKeys].every(key => targetOnKeys.has(key));
            return !(programSourceMatches && keysMatch);
        }

        function displayNewPrompt() {
             if (score >= GOAL_SCORE && !goalReached) {
                goalReached = true;
                gameStarted = false;
                dsk2Button.classList.add('active');
                currentPrompt = null;
                promptText.textContent = "Goal reached! Press DSK2 to end the production.";
                return;
            }

            if (availablePrompts.length === 0) {
                 promptText.textContent = `Training Complete! Final Score: ${score}. Press DSK2 to play again.`;
                 gameStarted = false;
                 dsk2Button.classList.add('active');
                 dsk2Overlay.classList.add('show');
                 currentPrompt = null;
                 return;
            }

            let potentialPrompts = availablePrompts.filter(isPromptValid);

            if (potentialPrompts.length === 0) {
                promptText.textContent = `All tasks complete! Final Score: ${score}. Press DSK2 to play again.`;
                 gameStarted = false;
                 dsk2Button.classList.add('active');
                 dsk2Overlay.classList.add('show');
                 currentPrompt = null;
                return;
            }
            
            const promptIndex = Math.floor(Math.random() * potentialPrompts.length);
            currentPrompt = potentialPrompts[promptIndex];
            
            availablePrompts = availablePrompts.filter(p => p !== currentPrompt);
            promptText.textContent = currentPrompt.text;
        }

        function evaluateProgramState() {
            if (!gameStarted || !currentPrompt) return;

            const actualProgramSource = document.querySelector('.program-bus .btn.active')?.dataset.sourceId;
            const actualOnKeys = new Set(activeKeys);

            const requiredSource = currentPrompt.targetSource;
            const requiredOnKeys = new Set();
            for (const keyIdStr in currentPrompt.targetKeys) {
                if (currentPrompt.targetKeys[keyIdStr] === 'on') {
                    requiredOnKeys.add(parseInt(keyIdStr));
                }
            }

            const sourceMatches = actualProgramSource === requiredSource;
            const keysMatch = actualOnKeys.size === requiredOnKeys.size && [...actualOnKeys].every(key => requiredOnKeys.has(key));

            if (sourceMatches && keysMatch) {
                handleCorrectAnswer();
            }
        }

        function handleCorrectAnswer() {
             const secondsPassed = lastCorrectTimestamp ? (Date.now() - lastCorrectTimestamp) / 1000 : 0;
             const pointsPerElement = Math.max(0, BASE_POINTS_PER_ELEMENT - Math.floor(secondsPassed * PENALTY_PER_SECOND));

             const keyElements = Object.keys(currentPrompt.targetKeys).length;
             const pointsEarned = (1 + keyElements) * pointsPerElement;
             score += pointsEarned;
             updateScoreboard();

            let feedbackMessage = "";
            if (pointsEarned === 0) {
                feedbackMessage = "ouch";
            } else if (secondsPassed < 5) {
                feedbackMessage = "EXCELLENT!!";
            } else if (secondsPassed <= 10) {
                feedbackMessage = "GOOD";
            } else if (secondsPassed <= 15) {
                feedbackMessage = "LETS GO FASTER";
            } else {
                feedbackMessage = "WE GOT THERE";
            }

             triggerSuccessAnimation(pointsEarned, feedbackMessage);

             lastCorrectTimestamp = Date.now();
             
             promptText.style.opacity = 0;
             currentPrompt = null; 

             setTimeout(() => {
                promptText.style.opacity = 1;
                displayNewPrompt();
             }, 1200);
        }
        
        // --- TRANSITION LOGIC ---
        function performTransition() {
            if (!gameStarted) return;

            const activePreviewButton = document.querySelector('.preview-bus .btn.active');
            const activeProgramButton = document.querySelector('.program-bus .btn.active');
            
            if (activePreviewButton) {
                const targetProgramButton = document.querySelector(`.program-bus .btn[data-source-id="${activePreviewButton.dataset.sourceId}"]`);
                if(targetProgramButton) targetProgramButton.dispatchEvent(new MouseEvent('click'));
            }
            if (activeProgramButton) {
                const targetPreviewButton = document.querySelector(`.preview-bus .btn[data-source-id="${activeProgramButton.dataset.sourceId}"]`);
                if(targetPreviewButton) targetPreviewButton.dispatchEvent(new MouseEvent('click'));
            }

            armedKeys.forEach(keyId => {
                const onButton = document.querySelector(`.on-btn[data-key-id="${keyId}"]`);
                if(onButton) onButton.dispatchEvent(new MouseEvent('click'));
            });
            
            evaluateProgramState();

            document.querySelectorAll('.keyer-btn.active').forEach(btn => btn.classList.remove('active'));
            armedKeys.clear();
        }

        // --- SWITCHER LOGIC ---
        function setupExclusiveBusRow(busSelector, screenContainer) {
            const bus = document.querySelector(busSelector);
            if (!bus) return;
            const buttons = bus.querySelectorAll('.btn');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.classList.contains('active')) return;
                    buttons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const sourceId = button.dataset.sourceId;
                    if (screenContainer && sourceId) {
                        const sourceElement = imageSources.querySelector(`#${sourceId}`);
                        if (sourceElement) screenContainer.innerHTML = sourceElement.outerHTML;
                    }
                    if(bus.classList.contains('program-bus')) evaluateProgramState();
                });
            });
        }
        
        function setupKeyOnButtons() {
            const onButtons = document.querySelectorAll('.on-btn');
            onButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const keyId = parseInt(button.dataset.keyId);
                    button.classList.toggle('active');
                    const keyOverlay = document.getElementById(`key-${keyId}-container`);
                    const graphicSourceId = keyerGraphics[keyId];
                    if (button.classList.contains('active')) {
                        activeKeys.add(keyId);
                        if(keyOverlay && graphicSourceId) keyOverlay.innerHTML = imageSources.querySelector(`#${graphicSourceId}`).outerHTML;
                        keyOverlay.classList.add('visible');
                    } else {
                        activeKeys.delete(keyId);
                        keyOverlay.classList.remove('visible');
                    }
                    evaluateProgramState();
                });
            });
        }
        
        function setupKeyerButtons() {
            const keyerButtons = document.querySelectorAll('.keyer-btn');
            keyerButtons.forEach(button => {
                button.addEventListener('click', () => {
                    button.classList.toggle('active');
                    const keyId = parseInt(button.dataset.keyId);
                    if(button.classList.contains('active')) {
                        armedKeys.add(keyId);
                    } else {
                        armedKeys.delete(keyId);
                    }
                });
            });
        }

        // --- INITIALIZATION ---
        setupExclusiveBusRow('.program-bus', programSourceContainer);
        setupExclusiveBusRow('.preview-bus', previewSourceContainer);
        setupKeyOnButtons();
        setupKeyerButtons();
        
        document.querySelectorAll('.btn').forEach(button => {
             button.addEventListener('mousedown', e => {
                playSound('click');
                e.currentTarget.classList.add('pushed');
             });
             button.addEventListener('mouseup', e => e.currentTarget.classList.remove('pushed'));
             button.addEventListener('mouseleave', e => e.currentTarget.classList.remove('pushed'));
        });

        document.querySelectorAll('.key-buttons .btn:not(.on-btn):not(.keyer-btn):not(.background-btn), .key-bus .btn, #dsk1-btn').forEach(button => {
            button.addEventListener('click', () => button.classList.toggle('active'));
        });
        
        const cutButton = document.querySelector('.cut-btn');
        const autoButton = document.querySelector('.auto-btn');
        cutButton.addEventListener('click', performTransition);
        autoButton.addEventListener('click', performTransition);
        
        dsk2Button.addEventListener('click', () => {
            if (goalReached) {
                triggerGoalReachedAnimation();
                goalReached = false;
                dsk2Button.classList.add('active'); // Keep it active for restart
                dsk2Overlay.classList.add('show');
                return;
            }
            dsk2Button.classList.toggle('active');
            if(gameStarted) {
                endGame();
            } else {
                startGame();
            }
        });

        goalOverlay.addEventListener('click', hideGoalOverlay);

        function setInitialState() {
            gameStarted = false; 
            goalReached = false;
            document.querySelector('.program-bus .btn[data-source-id="img-black"]')?.dispatchEvent(new MouseEvent('click'));
            document.querySelector('.preview-bus .btn[data-source-id="img-cam-1"]')?.dispatchEvent(new MouseEvent('click'));
            document.querySelector('.background-btn').classList.add('active');
            dsk2Button.classList.add('active');
            dsk2Overlay.classList.add('show');
            gameStarted = false; 
            promptText.textContent = "Press DSK2 to begin your training!";
            updateScoreboard();
        }

        setInitialState();

    </script>
</body>
</html>

